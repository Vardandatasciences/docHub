name: CI/CD - DocHub (Frontend + Backend)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  # Ports
  BACKEND_PORT: 8002
  FRONTEND_PORT: 8081
  # Server details
  SERVER_IP: 13.205.15.232
  DOMAIN: riskavaire.vardaands.com
  # ECR repository details
  AWS_REGION: ap-south-1
  ECR_REGISTRY: 480940871468.dkr.ecr.ap-south-1.amazonaws.com
  BACKEND_IMAGE: 480940871468.dkr.ecr.ap-south-1.amazonaws.com/dochub:backend-latest
  FRONTEND_IMAGE: 480940871468.dkr.ecr.ap-south-1.amazonaws.com/dochub:frontend-latest

jobs:
  # ============================================
  # JOB 1: Setup (Clean Docker)
  # ============================================
  setup:
    runs-on: self-hosted
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up Docker to free space
        run: |
          echo "Cleaning up Docker to free disk space..."
          docker container prune -f || true
          docker image prune -a -f || true
          docker volume prune -f || true
          docker builder prune -a -f || true
          echo "Disk space after cleanup:"
          df -h /

  # ============================================
  # JOB 2: Backend Build & Deploy
  # ============================================
  backend:
    runs-on: self-hosted
    needs: setup
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to ensure latest code

      - name: Show current commit
        run: |
          echo "Building from commit: ${{ github.sha }}"

      - name: Remove old Backend image
        run: |
          docker rmi dochub_backend:latest || true
          docker rmi "${BACKEND_IMAGE}" || true

      - name: Build Backend Docker image
        working-directory: backend
        run: |
          docker build --no-cache --pull -t dochub_backend:latest .

      - name: Tag Backend image for ECR
        run: |
          docker tag dochub_backend:latest "${BACKEND_IMAGE}"

      - name: Push Backend to ECR
        run: |
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
          docker push "${BACKEND_IMAGE}"

      - name: Deploy Backend container
        run: |
          # Stop and remove existing container if it exists
          if [ "$(docker ps -aq -f name=dochub_backend)" ]; then
            docker stop dochub_backend || true
            docker rm dochub_backend || true
          fi

          # Run new container on Docker's default bridge network
          docker run -d \
            --name dochub_backend \
            -p ${BACKEND_PORT}:8000 \
            --env-file /home/ubuntu/dochub.env \  # Ensure this points to the correct file
            -v /home/ubuntu/MEDIA_ROOT:/app/MEDIA_ROOT \
            -v /home/ubuntu/TEMP_MEDIA_ROOT:/app/TEMP_MEDIA_ROOT \
            -v /home/ubuntu/Reports:/app/Reports \
            --restart unless-stopped \
            dochub_backend:latest

          # Verify container is running
          sleep 2
          docker ps | grep dochub_backend || echo "WARNING: Container not running!"

  # ============================================
  # JOB 3: Frontend Build & Deploy
  # ============================================
  frontend:
    runs-on: self-hosted
    needs: setup
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to ensure latest code

      - name: Show current commit
        run: |
          echo "Building from commit: ${{ github.sha }}"

      - name: Remove old Frontend image
        run: |
          docker rmi dochub_frontend:latest || true
          docker rmi "${FRONTEND_IMAGE}" || true

      - name: Build Frontend Docker image
        run: |
          # Build with environment variables from .env.production if it exists
          # Otherwise use default backend URL
          if [ -f .env.production ]; then
            echo "Building with .env.production file"
            docker build --no-cache --pull -t dochub_frontend:latest .
          else
            echo "No .env.production found, using default backend URL"
            docker build \
              --build-arg VITE_API_BASE_URL=http://13.205.15.232:8002/api \
              --build-arg VITE_ENV=production \
              --no-cache --pull \
              -t dochub_frontend:latest .
          fi

      - name: Tag Frontend image for ECR
        run: |
          docker tag dochub_frontend:latest "${FRONTEND_IMAGE}"

      - name: Push Frontend to ECR
        run: |
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
          docker push "${FRONTEND_IMAGE}"

      - name: Deploy Frontend container
        run: |
          # Stop and remove existing container if it exists
          if [ "$(docker ps -aq -f name=dochub_frontend)" ]; then
            docker stop dochub_frontend || true
            docker rm dochub_frontend || true
          fi

          # Run new container on Docker's default bridge network
          docker run -d \
            --name dochub_frontend \
            -p ${FRONTEND_PORT}:80 \
            --restart unless-stopped \
            dochub_frontend:latest

          # Verify container is running
          sleep 2
          docker ps | grep dochub_frontend || echo "WARNING: Container not running!"

  # ============================================
  # JOB 4: Final Verification (After Both Deploy)
  # ============================================
  verify:
    runs-on: self-hosted
    needs: [backend, frontend]
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show all running containers
        run: |
          docker ps -a

      - name: Verify Backend via API proxy
        run: |
          sleep 5
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:${BACKEND_PORT}/api/)
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
            echo "SUCCESS: Backend API proxy is working! (HTTP $HTTP_CODE)"
          else
            echo "ERROR: Backend API proxy not responding"
          fi

      - name: Verify Frontend accessibility
        run: |
          sleep 5
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:${FRONTEND_PORT}/)
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
            echo "SUCCESS: Frontend is accessible! (HTTP $HTTP_CODE)"
          else
            echo "ERROR: Frontend not responding"
          fi
